<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Technical SEO Quiz</title>

  <!-- SNSå‘ã‘ï¼ˆæœ€ä½é™ï¼‰ -->
  <meta property="og:title" content="Technical SEO Quiz" />
  <meta property="og:description" content="Browser-based Technical SEO quiz game (Crawl / Index / CWV / Canonical / Rendering)." />
  <meta property="og:url" content="https://takuma51.github.io/techseo-quiz/" />
  <meta name="twitter:card" content="summary_large_image" />

  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0e1630;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --brand:#7c5cff;
      --brand2:#22c1c3;
      --ok:#2dd4bf;
      --ng:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:18px;
      --r2:24px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,92,255,.35), transparent 55%),
        radial-gradient(900px 520px at 95% 10%, rgba(34,193,195,.25), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:26px 18px 80px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(34,193,195,.9));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute;inset:10px;
      border-radius:12px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.18);
    }
    h1{font-size:24px;margin:0}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .card{
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .grid{
      display:grid;gap:14px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-size:13px;
    }
    .pill b{font-variant-numeric:tabular-nums}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .muted{color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease, background .15s ease;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(135deg, rgba(124,92,255,.34), rgba(34,193,195,.16));
    }
    .btn.ghost{background: transparent}
    .btn.good{border-color: rgba(45,212,191,.55)}
    .btn.bad{border-color: rgba(251,113,133,.55)}

    select,input{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
    }
    input{width:110px}

    .progress{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(124,92,255,.95), rgba(34,193,195,.95));
      border-radius:999px;
      transition: width .25s ease;
    }

    .qmeta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{
      font-size:12px; padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke); background: rgba(255,255,255,.04);
      color:var(--muted);
    }
    .qtitle{font-size:20px;margin:10px 0 12px;line-height:1.35}
    .choices{display:grid;gap:10px}
    .choice{
      text-align:left;
      padding:12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.045);
      border:1px solid rgba(255,255,255,.12);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .choice:hover{background: rgba(255,255,255,.06)}
    .choice.correct{border-color: rgba(45,212,191,.55); background: rgba(45,212,191,.10)}
    .choice.wrong{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.10)}

    .feedback{
      display:none;
      margin-top:12px;
      padding:14px;
      border-radius: var(--r);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
    }
    .feedback.show{display:block}
    .ok{color:var(--ok)} .ng{color:var(--ng)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:20px;
      z-index:50;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(560px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 28px 90px rgba(0,0,0,.55);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .modal h3{margin:0 0 6px;font-size:18px}
    .modal .big{font-size:28px;margin:6px 0 10px}
    .modal .sub{color:var(--muted);font-size:13px}
    .modal .row{margin-top:12px;justify-content:flex-end}
    .glow{
      position:absolute; inset:-80px;
      background: radial-gradient(600px 320px at 40% 20%, rgba(124,92,255,.45), transparent 60%),
                  radial-gradient(520px 280px at 80% 10%, rgba(34,193,195,.35), transparent 62%);
      filter: blur(10px);
      opacity:.85;
      pointer-events:none;
    }

    /* Confetti */
    .confetti{
      position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:60;
      display:none;
    }
    .confetti.show{display:block}
    .piece{
      position:absolute;
      width:10px;height:16px;
      border-radius: 4px;
      opacity:.95;
      top:-20px;
      animation: fall linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(calc(100vh + 40px)) rotate(720deg); }
    }

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
    .tiny{font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Technical SEO Quiz</h1>
          <div class="subtitle">ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§å‹•ãï¼URLå…±æœ‰OKã€‚ãƒ©ãƒ³ã‚¯ã§æˆé•·ãŒè¦‹ãˆã‚‹ã‚¯ã‚¤ã‚ºã€‚</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="shareBtn">ğŸ”— URLã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn ghost" id="resetBestBtn">ğŸ§¹ è¨˜éŒ²ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row space">
          <div class="row">
            <span class="pill">ã‚¹ã‚³ã‚¢ <b id="score">0</b></span>
            <span class="pill">æ­£è§£æ•° <b id="correct">0</b></span>
            <span class="pill">é€£ç¶š <b id="streak">0</b></span>
            <span class="pill">æ®‹ã‚Š <b id="remaining">0</b></span>
            <span class="pill">ã‚¿ã‚¤ãƒ  <b id="time">â€”</b></span>
          </div>
          <span class="pill">ãƒ©ãƒ³ã‚¯ <b id="rank">â€”</b></span>
        </div>

        <div class="hr"></div>

        <div class="row">
          <span class="muted tiny">å‡ºé¡Œ</span>
          <select id="mode">
            <option value="all">ã™ã¹ã¦</option>
            <option value="Crawl">Crawl</option>
            <option value="Index">Index</option>
            <option value="CWV">CWV</option>
            <option value="Rendering">Rendering</option>
            <option value="Schema">Schema</option>
            <option value="Logs">Logs</option>
          </select>

          <span class="muted tiny">ä¸¦ã³</span>
          <select id="order">
            <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
            <option value="sequential">é †ç•ª</option>
          </select>

          <span class="muted tiny">åˆ¶é™(ç§’)</span>
          <input id="limit" type="number" min="0" value="20" />

          <button class="btn primary" id="startBtn">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button class="btn" id="importBtn">â¬†ï¸ å•é¡ŒJSONã‚’è²¼ã‚Šä»˜ã‘</button>
        </div>

        <div class="hr"></div>

        <div class="row space">
          <div style="flex:1;min-width:220px">
            <div class="muted tiny" id="progressLabel">é€²æ— 0 / 0</div>
            <div class="progress"><div class="bar" id="bar"></div></div>
          </div>
          <div class="muted tiny" id="bestBox">è‡ªå·±ãƒ™ã‚¹ãƒˆ: <b id="best">0</b> / æœ€é«˜ãƒ©ãƒ³ã‚¯: <b id="bestRank">â€”</b></div>
        </div>
      </div>

      <div class="card" id="qCard">
        <div class="qmeta" id="qMeta"></div>
        <div class="qtitle" id="question">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­</div>
        <div class="choices" id="choices"></div>

        <div class="feedback" id="feedback"></div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="skipBtn">â­ï¸ ã‚¹ã‚­ãƒƒãƒ—</button>
          <button class="btn" id="revealBtn">ğŸ’¡ è§£èª¬ã‚’è¦‹ã‚‹</button>
          <button class="btn primary" id="nextBtn">â¡ï¸ æ¬¡ã¸</button>
        </div>

        <div class="muted tiny" style="margin-top:10px">
          ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: <span class="kbd">1-4</span>ã§å›ç­” / <span class="kbd">Enter</span>ã§æ¬¡ã¸
        </div>
      </div>
    </div>

    <footer>
      Created by <b>Takuma Oka</b> Â· Technical SEO Quiz
    </footer>
  </div>

  <!-- Rank modal -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="glow"></div>
      <h3>ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ï¼</h3>
      <div class="big" id="rankTitle">â€”</div>
      <div class="sub" id="rankSub">â€”</div>
      <div class="row">
        <button class="btn primary" id="closeModalBtn">OK</button>
      </div>
    </div>
  </div>

  <div class="confetti" id="confetti"></div>

  <!-- Import modal (simple prompt-like) -->
  <div class="overlay" id="importOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="glow"></div>
      <h3>å•é¡ŒJSONã‚’è²¼ã‚Šä»˜ã‘</h3>
      <div class="sub">å½¢å¼: [{ id, level, tags:[...], q, choices:[...], answer, explain }...]</div>
      <div style="margin-top:10px">
        <textarea id="importArea" style="width:100%;height:200px;border-radius:16px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--text);padding:12px;outline:none"></textarea>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:12px">
        <button class="btn" id="cancelImportBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" id="applyImportBtn">é©ç”¨</button>
      </div>
    </div>
  </div>

<script>
/** =========================================================
 *  1) QUESTIONSï¼ˆã“ã“ã‚’100å•ã«å¢—ã‚„ã—ã¦ã„ãï¼‰
 *     â€» ã¾ãšã¯å‹•ä½œç¢ºèªç”¨ã«ä¸€éƒ¨ã ã‘å…¥ã‚Œã¦ã‚ã‚‹
 *     â€» ã€ŒImportï¼ˆJSONè²¼ã‚Šä»˜ã‘ï¼‰ã€ã§ä¸€æ°—ã«100å•æŠ•å…¥ã‚‚å¯èƒ½
 *  ========================================================= */
let QUESTIONS = [
  {
    id: "robots-vs-noindex",
    level: "Easy",
    tags: ["Index","Robots"],
    q: "robots.txtã§ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸURLã« meta robots noindex ã‚’å…¥ã‚ŒãŸã€‚èµ·ã“ã‚Šã‚„ã™ã„ã®ã¯ï¼Ÿ",
    choices: [
      "noindex ãŒç¢ºå®Ÿã«åŠ¹ãã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰æ¶ˆãˆã‚‹",
      "ã‚¯ãƒ­ãƒ¼ãƒ«ã§ããªã„ã®ã§ noindex ã‚’èª­ã‚ãšã€URLãŒæ®‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹",
      "canonical ãŒè‡ªå‹•ã§ä»˜ä¸ã•ã‚Œçµ±åˆã•ã‚Œã‚‹",
      "å¿…ãš 404 æ‰±ã„ã«ãªã‚‹"
    ],
    answer: 1,
    explain: "noindexã¯ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã§ãã¦åˆã‚ã¦è§£é‡ˆã•ã‚Œã‚„ã™ã„ã€‚robotsã§ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã¨noindexã‚’èª­ã‚ãšã€URLã®ã¿æ®‹ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã€‚"
  },
  {
    id: "canonical-signal",
    level: "Easy",
    tags: ["Index","Canonical"],
    q: "rel=canonical ã®æœ€ã‚‚æ­£ã—ã„ä½ç½®ã¥ã‘ã¯ï¼Ÿ",
    choices: [
      "å¿…ãšæ­£è¦URLã«301ã•ã‚Œã‚‹",
      "æ­£è¦URLã®â€œã‚·ã‚°ãƒŠãƒ«â€ã‚’ä¼ãˆã‚‹ï¼ˆå¿…ãšå¾“ã†ã¨ã¯é™ã‚‰ãªã„ï¼‰",
      "é‡è¤‡ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•ã§noindexã«ã™ã‚‹å‘½ä»¤",
      "ã‚µã‚¤ãƒˆå…¨ä½“ã®ã‚¯ãƒ­ãƒ¼ãƒ«é »åº¦ã‚’ä¸Šã’ã‚‹"
    ],
    answer: 1,
    explain: "canonicalã¯å¼·åˆ¶ã§ã¯ãªããƒ’ãƒ³ãƒˆã€‚å†…éƒ¨ãƒªãƒ³ã‚¯/ã‚µã‚¤ãƒˆãƒãƒƒãƒ—/ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãªã©æ•´åˆæ€§ãŒé‡è¦ã€‚"
  },
  {
    id: "sitemap-role",
    level: "Easy",
    tags: ["Crawl","Sitemap"],
    q: "XMLã‚µã‚¤ãƒˆãƒãƒƒãƒ—ã®æ­£ã—ã„å½¹å‰²ã¯ï¼Ÿ",
    choices: [
      "æ²è¼‰URLã¯å¿…ãšã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã•ã‚Œã‚‹ä¿è¨¼",
      "ç™ºè¦‹/å„ªå…ˆåº¦ã®ãƒ’ãƒ³ãƒˆï¼ˆä¿è¨¼ã§ã¯ãªã„ï¼‰",
      "ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¦å› ãã®ã‚‚ã®",
      "é‡è¤‡URLã‚’è‡ªå‹•å‰Šé™¤ã™ã‚‹ä»•çµ„ã¿"
    ],
    answer: 1,
    explain: "ã‚µã‚¤ãƒˆãƒãƒƒãƒ—ã¯ç™ºè¦‹ã¨ã‚¯ãƒ­ãƒ¼ãƒ«ã®æ‰‹ãŒã‹ã‚Šã€‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯å“è³ª/é‡è¤‡/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç­‰ã®åˆ¥è¦å› ã€‚"
  },
  {
    id: "cwv-lcp",
    level: "Medium",
    tags: ["CWV","Performance"],
    q: "LCPæ”¹å–„ã¨ã—ã¦åŠ¹æœãŒå‡ºã‚„ã™ã„ã®ã¯ï¼Ÿ",
    choices: [
      "å…¨ç”»åƒã‚’PNGã«çµ±ä¸€ã™ã‚‹",
      "LCPè¦ç´ ï¼ˆãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒç­‰ï¼‰ã‚’å„ªå…ˆèª­ã¿è¾¼ã¿ã—ã€ä¸è¦JSã‚’æ¸›ã‚‰ã™",
      "ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ã‚°ã‚’çŸ­ãã™ã‚‹",
      "h1ã‚’è¤‡æ•°ã«ã™ã‚‹"
    ],
    answer: 1,
    explain: "LCPã¯æœ€å¤§è¦ç´ è¡¨ç¤ºã€‚ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ/ãƒ•ã‚©ãƒ³ãƒˆã®å„ªå…ˆèª­ã¿è¾¼ã¿ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã®å‰Šæ¸›ãŒåŠ¹ãã‚„ã™ã„ã€‚"
  },
  {
    id: "rendering-js",
    level: "Medium",
    tags: ["Rendering"],
    q: "JSãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¾å­˜ãŒå¼·ã„ã‚µã‚¤ãƒˆã§èµ·ãã‚„ã™ã„SEOèª²é¡Œã¯ï¼Ÿ",
    choices: [
      "titleã‚¿ã‚°ãŒè‡ªå‹•ã§æ¶ˆãˆã‚‹",
      "ã‚µãƒ¼ãƒãƒ¼ãŒå¿…ãšè½ã¡ã‚‹",
      "åˆå›HTMLã«ä¸»è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç„¡ãã€ç™ºè¦‹/è©•ä¾¡ãŒé…ã‚Œã‚‹å¯èƒ½æ€§",
      "å¿…ãšã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¢—ãˆã‚‹"
    ],
    answer: 2,
    explain: "åˆæœŸHTMLãŒè–„ã„ã¨ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾…ã¡ã«ãªã‚Šç™ºè¦‹/è©•ä¾¡ãŒé…ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚SSR/Prerender/é©åˆ‡ãªå†…éƒ¨ãƒªãƒ³ã‚¯ç­‰ã§è£œã†ã€‚"
  }
];

/** =========================================================
 *  2) ãƒ©ãƒ³ã‚¯è¨­è¨ˆï¼ˆâ€œæ­£è§£æ•°â€ã§ãƒ©ãƒ³ã‚¯ä»˜ä¸ï¼‰
 *     100å•ã«ã—ãŸæ™‚ã«æ˜ ãˆã‚‹ã‚ˆã†ã«è¨­è¨ˆ
 *  ========================================================= */
const RANKS = [
  { name: "Novice",        minCorrect: 0,   msg: "ã¾ãšã¯ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã€‚åŸºç¤ã‹ã‚‰ç©ã¿ä¸Šã’ã‚ˆã†ã€‚" },
  { name: "Apprentice",    minCorrect: 10,  msg: "ã„ã„æ„Ÿã˜ã€‚ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£/ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åŸºæœ¬ãŒè¦‹ãˆã¦ããŸã€‚" },
  { name: "Specialist",    minCorrect: 25,  msg: "å®Ÿå‹™ãƒ¬ãƒ™ãƒ«ã€‚æŠ€è¡“SEOã®å…¨ä½“åƒãŒæ•´ç†ã§ãã¦ã„ã‚‹ã€‚" },
  { name: "Senior",        minCorrect: 50,  msg: "å¼·ã„ã€‚è¨­è¨ˆã¨æ”¹å–„ã®æ‰“ã¡æ‰‹ãŒå®‰å®šã—ã¦ã„ã‚‹ã€‚" },
  { name: "Architect",     minCorrect: 75,  msg: "è¨­è¨ˆè€…ã€‚å¤§è¦æ¨¡ã‚µã‚¤ãƒˆã§ã‚‚æˆ¦ãˆã‚‹ã€‚" },
  { name: "Legend",        minCorrect: 100, msg: "åˆ°é”ç‚¹ã€‚ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«SEOã®ç·åˆåŠ›ãŒé«˜ã„ã€‚" }
];

const STORAGE_KEY = "techseo_state_v2";

/** =========================================================
 *  3) çŠ¶æ…‹
 *  ========================================================= */
const $ = (id)=>document.getElementById(id);

const scoreEl = $("score");
const correctEl = $("correct");
const streakEl = $("streak");
const remainingEl = $("remaining");
const timeEl = $("time");
const bestEl = $("best");
const bestRankEl = $("bestRank");
const rankEl = $("rank");
const qMetaEl = $("qMeta");
const qEl = $("question");
const choicesEl = $("choices");
const feedbackEl = $("feedback");
const barEl = $("bar");
const progressLabelEl = $("progressLabel");
const bestBoxEl = $("bestBox");

const modeEl = $("mode");
const orderEl = $("order");
const limitEl = $("limit");

const startBtn = $("startBtn");
const nextBtn = $("nextBtn");
const skipBtn = $("skipBtn");
const revealBtn = $("revealBtn");
const resetBestBtn = $("resetBestBtn");
const shareBtn = $("shareBtn");

const overlay = $("overlay");
const rankTitle = $("rankTitle");
const rankSub = $("rankSub");
const closeModalBtn = $("closeModalBtn");

const confetti = $("confetti");

const importBtn = $("importBtn");
const importOverlay = $("importOverlay");
const importArea = $("importArea");
const cancelImportBtn = $("cancelImportBtn");
const applyImportBtn = $("applyImportBtn");

let deck = [];
let idx = 0;
let current = null;
let locked = false;

let timer = null;
let remaining = 0;

let score = 0;
let correct = 0;
let streak = 0;

let best = 0;
let bestRank = "â€”";
let lastRankShown = "Novice";

/** =========================================================
 *  4) ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 *  ========================================================= */
function shuffle(arr){
  const a = [...arr];
  for (let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function getRankNameByCorrect(c){
  let r = RANKS[0];
  for (const item of RANKS){
    if (c >= item.minCorrect) r = item;
  }
  return r.name;
}
function getRankByName(name){
  return RANKS.find(r=>r.name===name) || RANKS[0];
}

function updateRankUI(){
  const rn = getRankNameByCorrect(correct);
  rankEl.textContent = rn;
  return rn;
}

function saveState(){
  const state = {
    best,
    bestRank,
    lastRankShown,
    importedQuestions: QUESTIONS
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    if(typeof s.best === "number") best = s.best;
    if(typeof s.bestRank === "string") bestRank = s.bestRank;
    if(typeof s.lastRankShown === "string") lastRankShown = s.lastRankShown;
    if(Array.isArray(s.importedQuestions) && s.importedQuestions.length){
      // ä»¥å‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå•é¡ŒãŒã‚ã‚Œã°å¾©å…ƒ
      QUESTIONS = s.importedQuestions;
    }
  }catch(e){}
}

function setProgress(){
  const total = deck.length || 0;
  const done = Math.min(idx, total);
  progressLabelEl.textContent = `é€²æ— ${done} / ${total}`;
  const pct = total ? (done/total)*100 : 0;
  barEl.style.width = `${pct}%`;
}

function setTimer(){
  clearInterval(timer);
  const limit = Math.max(0, Number(limitEl.value || 0));
  if(limit === 0){
    timeEl.textContent = "âˆ";
    return;
  }
  remaining = limit;
  timeEl.textContent = String(remaining);
  timer = setInterval(()=>{
    remaining--;
    timeEl.textContent = String(remaining);
    if(remaining <= 0){
      clearInterval(timer);
      timeEl.textContent = "0";
      if(!locked) judge(-1);
    }
  },1000);
}

function buildDeck(){
  const tag = modeEl.value;
  const filtered = QUESTIONS.filter(q=>{
    if(tag === "all") return true;
    return (q.tags || []).includes(tag);
  });

  // 0ä»¶å¯¾ç­–
  const use = filtered.length ? filtered : QUESTIONS;

  deck = use.map(q=>q.id);
  if(orderEl.value === "random") deck = shuffle(deck);
  idx = 0;

  remainingEl.textContent = String(deck.length);
  setProgress();
}

function getById(id){
  return QUESTIONS.find(q=>q.id===id);
}

function renderMeta(q){
  const chips = [];
  chips.push(`<span class="chip">Lv: ${q.level || "â€”"}</span>`);
  (q.tags||[]).forEach(t=>chips.push(`<span class="chip">${t}</span>`));
  qMetaEl.innerHTML = chips.join("");
}

/** =========================================================
 *  5) Confetti / Rank Modal
 *  ========================================================= */
function popConfetti(){
  confetti.innerHTML = "";
  confetti.classList.add("show");
  const colors = [
    "rgba(124,92,255,.95)",
    "rgba(34,193,195,.95)",
    "rgba(255,255,255,.9)",
    "rgba(45,212,191,.95)",
    "rgba(251,113,133,.95)"
  ];
  const count = 70;
  for(let i=0;i<count;i++){
    const d = document.createElement("div");
    d.className = "piece";
    d.style.left = Math.random()*100 + "vw";
    d.style.background = colors[Math.floor(Math.random()*colors.length)];
    d.style.animationDuration = (1.8 + Math.random()*1.6) + "s";
    d.style.animationDelay = (Math.random()*0.15) + "s";
    d.style.transform = `rotate(${Math.random()*180}deg)`;
    d.style.width = (8 + Math.random()*10) + "px";
    d.style.height = (10 + Math.random()*16) + "px";
    confetti.appendChild(d);
  }
  setTimeout(()=>confetti.classList.remove("show"), 2400);
}

function showRankModal(rankName){
  const r = getRankByName(rankName);
  rankTitle.textContent = rankName;
  rankSub.textContent = `æ­£è§£æ•° ${correct} é”æˆï¼ ${r.msg}`;
  overlay.classList.add("show");
  popConfetti();
}

function closeModal(){
  overlay.classList.remove("show");
}

/** =========================================================
 *  6) ã‚²ãƒ¼ãƒ 
 *  ========================================================= */
function renderQuestion(){
  locked = false;
  feedbackEl.classList.remove("show");
  feedbackEl.innerHTML = "";

  const id = deck[idx];
  current = getById(id);

  remainingEl.textContent = String(deck.length - idx);
  setProgress();

  renderMeta(current);
  qEl.textContent = current.q;

  choicesEl.innerHTML = "";
  (current.choices || []).forEach((text,i)=>{
    const b = document.createElement("button");
    b.className = "btn choice";
    b.innerHTML = `<b style="opacity:.9">${i+1}.</b> ${text}`;
    b.onclick = ()=>judge(i);
    choicesEl.appendChild(b);
  });

  setTimer();
}

function endScreen(){
  clearInterval(timer);
  qMetaEl.innerHTML = "";
  const total = deck.length || 0;
  const acc = total ? Math.round((correct/total)*100) : 0;

  qEl.textContent = `çµ‚äº†ï¼ ã‚¹ã‚³ã‚¢ ${score} / æ­£è§£ ${correct}/${total}ï¼ˆæ­£ç­”ç‡ ${acc}%ï¼‰`;
  choicesEl.innerHTML = "";

  feedbackEl.classList.add("show");
  feedbackEl.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div><b>æœ€çµ‚ãƒ©ãƒ³ã‚¯:</b> <span class="ok">${getRankNameByCorrect(correct)}</span></div>
      <div class="muted">è‡ªå·±ãƒ™ã‚¹ãƒˆ: <b>${best}</b> / æœ€é«˜ãƒ©ãƒ³ã‚¯: <b>${bestRank}</b></div>
    </div>
    <div class="hr"></div>
    <div class="muted">æ¬¡ã®ç›®æ¨™: æ­£è§£æ•°ã‚’å¢—ã‚„ã—ã¦ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã‚’ç‹™ãŠã†ï¼ˆ100å•ç‰ˆã ã¨ã€ŒLegendã€åˆ°é”ãŒç†±ã„ï¼‰ã€‚</div>
  `;
  timeEl.textContent = "â€”";
  remainingEl.textContent = "0";
  setProgress();
}

function updateHUD(){
  scoreEl.textContent = String(score);
  correctEl.textContent = String(correct);
  streakEl.textContent = String(streak);

  const rn = updateRankUI();

  // æœ€é«˜è¨˜éŒ²æ›´æ–°
  if(score > best){
    best = score;
    bestEl.textContent = String(best);
  }
  // æœ€é«˜ãƒ©ãƒ³ã‚¯æ›´æ–°
  const currentRankIndex = RANKS.findIndex(r=>r.name===rn);
  const bestRankIndex = RANKS.findIndex(r=>r.name===bestRank);
  if(currentRankIndex > bestRankIndex){
    bestRank = rn;
    bestRankEl.textContent = bestRank;
  }
  saveState();
}

function judge(choiceIndex){
  if(!current || locked) return;
  locked = true;
  clearInterval(timer);

  const correctIndex = current.answer;
  const buttons = [...choicesEl.querySelectorAll("button.choice")];

  // time out or reveal
  const isTimeout = (choiceIndex === -1);
  const isReveal = (choiceIndex === -2);

  let ok = false;
  if(!isTimeout && !isReveal){
    ok = (choiceIndex === correctIndex);
  }

  // mark
  buttons.forEach((b,i)=>{
    if(i === correctIndex) b.classList.add("correct");
    if(!ok && i === choiceIndex) b.classList.add("wrong");
  });

  if(ok){
    correct += 1;
    score += 10 + Math.min(10, streak);
    streak += 1;
  }else{
    streak = 0;
  }

  // rank up check
  const before = getRankNameByCorrect(correct - (ok ? 1 : 0));
  const after  = getRankNameByCorrect(correct);
  if(after !== before && after !== lastRankShown){
    lastRankShown = after;
    showRankModal(after);
  }

  updateHUD();

  const status = ok ? `<b class="ok">æ­£è§£</b>` : `<b class="ng">${isTimeout ? "æ™‚é–“åˆ‡ã‚Œ" : (isReveal ? "è§£èª¬è¡¨ç¤º" : "ä¸æ­£è§£")}</b>`;
  feedbackEl.classList.add("show");
  feedbackEl.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>${status} <span class="muted">ï¼ˆæ­£è§£: ${correctIndex+1}ï¼‰</span></div>
      <div class="muted">ã‚¿ã‚°: ${(current.tags||[]).join(", ")}</div>
    </div>
    <div class="hr"></div>
    <div>${current.explain || ""}</div>
  `;
}

function next(){
  clearInterval(timer);
  if(!deck.length) return;
  idx++;
  if(idx >= deck.length){
    endScreen();
    return;
  }
  renderQuestion();
}

function start(){
  // reset run stats
  score = 0;
  correct = 0;
  streak = 0;
  idx = 0;
  locked = false;
  lastRankShown = "Novice";

  scoreEl.textContent = "0";
  correctEl.textContent = "0";
  streakEl.textContent = "0";
  timeEl.textContent = "â€”";

  buildDeck();
  updateRankUI();
  updateHUD();

  renderQuestion();
}

/** =========================================================
 *  7) Import JSONï¼ˆ100å•ã‚’ä¸€æ°—ã«æŠ•å…¥ã§ãã‚‹ï¼‰
 *  ========================================================= */
function openImport(){
  importArea.value = JSON.stringify(QUESTIONS, null, 2);
  importOverlay.classList.add("show");
}
function closeImport(){
  importOverlay.classList.remove("show");
}
function applyImport(){
  try{
    const parsed = JSON.parse(importArea.value);
    if(!Array.isArray(parsed)) throw new Error("é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");

    // ã–ã£ãã‚Šæ¤œè¨¼
    for(const q of parsed){
      if(!q.id || !q.q || !Array.isArray(q.choices) || typeof q.answer !== "number"){
        throw new Error("å½¢å¼ãŒä¸æ­£ãªå•é¡ŒãŒå«ã¾ã‚Œã¦ã„ã¾ã™");
      }
      if(q.choices.length < 2) throw new Error("choicesãŒå°‘ãªã™ãã¾ã™");
    }

    QUESTIONS = parsed;
    saveState();
    closeImport();
    alert(`é©ç”¨ã—ã¾ã—ãŸï¼š${QUESTIONS.length}å•`);
  }catch(e){
    alert("JSONã®å½¢å¼ã‚¨ãƒ©ãƒ¼: " + e.message);
  }
}

/** =========================================================
 *  8) ã‚¤ãƒ™ãƒ³ãƒˆ
 *  ========================================================= */
startBtn.onclick = start;
nextBtn.onclick = next;

skipBtn.onclick = ()=>{
  if(!current) return;
  streak = 0;
  updateHUD();
  next();
};

revealBtn.onclick = ()=>{
  if(!current || locked) return;
  judge(-2);
};

resetBestBtn.onclick = ()=>{
  localStorage.removeItem(STORAGE_KEY);
  best = 0;
  bestRank = "â€”";
  bestEl.textContent = "0";
  bestRankEl.textContent = "â€”";
  alert("è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
};

shareBtn.onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(location.href);
    shareBtn.textContent = "âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
    setTimeout(()=>shareBtn.textContent="ğŸ”— URLã‚’ã‚³ãƒ”ãƒ¼", 1200);
  }catch(e){
    prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰:", location.href);
  }
};

closeModalBtn.onclick = closeModal;
overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeModal(); });

importBtn.onclick = openImport;
cancelImportBtn.onclick = closeImport;
applyImportBtn.onclick = applyImport;
importOverlay.addEventListener("click", (e)=>{ if(e.target===importOverlay) closeImport(); });

document.addEventListener("keydown",(e)=>{
  if(overlay.classList.contains("show")){
    if(e.key==="Escape" || e.key==="Enter") closeModal();
    return;
  }
  if(importOverlay.classList.contains("show")){
    if(e.key==="Escape") closeImport();
    return;
  }
  if(!current) return;
  if(e.key >= "1" && e.key <= "4" && !locked){
    judge(Number(e.key)-1);
  }
  if(e.key === "Enter") next();
});

/** =========================================================
 *  9) åˆæœŸåŒ–ï¼ˆä¿å­˜æ¸ˆã¿ãŒã‚ã‚Œã°å¾©å…ƒï¼‰
 *  ========================================================= */
loadState();
bestEl.textContent = String(best);
bestRankEl.textContent = bestRank;

</script>
</body>
</html>
